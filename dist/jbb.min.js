/* JBB Binary Bundle Loader - https://github.com/wavesoft/jbb */
var JBBBinaryLoader=function(t){function r(i){if(e[i])return e[i].exports;var n=e[i]={exports:{},id:i,loaded:!1};return t[i].call(n.exports,n,n.exports,r),n.loaded=!0,n.exports}var e={};return r.m=t,r.c=e,r.p="",r(0)}([function(t,r,e){"use strict";function i(t,r){var e=t.readStringLT(),i=new Blob([t.readTypedArray[p.UINT8](r)],{type:e});return URL.createObjectURL(i)}function n(t,r,e){var n,s=[p.UINT8,p.UINT16,p.UINT32,p.FLOAT64][r],a=t.readTypedNum[s]();if(0===e)return n=String.fromCharCode.apply(null,t.readTypedArray[p.UINT8](a));if(1===e)return n=String.fromCharCode.apply(null,t.readTypedArray[p.UINT16](a));if(2===e){var u=document.createElement("img");return u.src=i(t,a),u}if(4===e){var u=document.createElement("script");return u.src=i(t,a),u}if(7===e)return i(t,a);throw{name:"AssertError",message:"Unknown buffer type #"+e+"!",toString:function(){return this.name+": "+this.message}}}function s(t,r,e){if(!(32&e&&32!==(48&e))){var i=e;32&e&&(i=t.readTypedNum[p.UINT8]()|(15&e)<<8);var n=t.ot.ENTITIES[i];if(void 0===n)throw{name:"AssertError",message:"Could not found known object entity #"+i+"!",toString:function(){return this.name+": "+this.message}};var s=n[1](n[0]);t.iref_table.push(s);var a=T(t,r);return n[2](s,t.ot.PROPERTIES[i],a),s}if(56!==(60&e)){if(48===(56&e)){var i=(7&e)<<8|t.readTypedNum[p.UINT8](),u=t.factory_plain[i];if(void 0===u)throw{name:"AssertError",message:"Could not found simple object signature with id #"+i+"!",toString:function(){return this.name+": "+this.message}};var o=T(t,r);return u(o)}throw{name:"AssertError",message:"Unexpected object opcode #"+e+"!",toString:function(){return this.name+": "+this.message}}}var h=3&e;switch(h){case 0:var f=t.readTypedNum[p.FLOAT64]();10*t.readTypedNum[p.INT8]();return new Date(f);default:throw{name:"AssertError",message:"Unknown primitive object with POID #"+h+"!",toString:function(){return this.name+": "+this.message}}}}function a(t,r,e,i){for(var n=new v[I.FROM[i]](e),s=I.TO[i],a=t.readTypedNum[I.FROM[i]](),u=t.readTypedNum[p.FLOAT64](),o=t.readTypedArray[s](e),h=0;e>h;h++)n[h]=a+o[h]*u;return n}function u(t,r,e,i){var n=new v[N.FROM[i]](e),s=t.readTypedNum[N.FROM[i]](),a=t.readTypedArray[N.TO[i]](e-1);n[0]=s;for(var u=0,o=a.length;o>u;u++)s+=a[u],n[u+1]=s;return n}function o(t,r){var e=t.readTypedNum[p.UINT16](),i=t.signature_table[e],n=t.factory_plain_bulk[e];if(!i)throw{name:"AssertError",message:"Unknown plain object with signature #"+e+"!",toString:function(){return this.name+": "+this.message}};for(var s=[],a=0,u=i.length;u>a;a++)s.push(T(t,r));for(var o=[],h=s[0].length,a=0;h>a;a++)o.push(n(s,a));return o}function h(t,r){for(var e,i=t.readTypedNum[p.UINT8](),n=[],s=[];127!==i;){if(e=f(t,r,i),s.push({type:i,len:e.length}),void 0===e.length)throw{name:"AssertError",message:"Encountered non-array chunk as part of chunked array!",toString:function(){return this.name+": "+this.message}};n=n.concat(Array.prototype.slice.call(e)),i=t.readTypedNum[p.UINT8]()}return n}function f(t,r,e){var i,n,s,f,d,c=[];if(108===e)return o(t,r);if(109!==e){if(110===e){for(f=t.readTypedNum[p.UINT8](),i=0;f>i;i++)c.push(T(t,r));return c}if(111===e)return h(t,r);if(126===e)return[];if(127===e)throw{name:"AssertError",message:"Encountered PRIM_CHUNK_END outside of chunked array!",toString:function(){return this.name+": "+this.message}};if(0===(224&e))return s=1&e,n=e>>1&15,f=t.readTypedNum[s?p.UINT32:p.UINT16](),d=t.readTypedArray[g.TO[n]](f),c=new v[g.FROM[n]](d);if(32===(240&e))return s=1&e,n=e>>1&7,f=t.readTypedNum[s?p.UINT32:p.UINT16](),u(t,r,f,n);if(48===(240&e))return s=1&e,n=e>>1&7,f=t.readTypedNum[s?p.UINT32:p.UINT16](),a(t,r,f,n);if(64===(240&e))return s=1&e,n=e>>1&7,f=t.readTypedNum[s?p.UINT32:p.UINT16](),d=t.readTypedNum[n](),c=new v[n](f),c.fill(d),c;if(80===(240&e))return s=1&e,n=e>>1&7,f=t.readTypedNum[s?p.UINT32:p.UINT16](),c=t.readTypedArray[n](f);if(96===(248&e))return n=7&e,f=t.readTypedNum[p.UINT8](),c=t.readTypedArray[n](f);if(104===(254&e))return s=1&e,f=t.readTypedNum[s?p.UINT32:p.UINT16](),d=T(t,r),c=new Array(f),c.fill(d),c;if(106===(254&e)){for(s=1&e,f=t.readTypedNum[s?p.UINT32:p.UINT16](),i=0;f>i;i++)c.push(T(t,r));return c}throw{name:"AssertError",message:"Unknown array op-code #"+e+"!",toString:function(){return this.name+": "+this.message}}}}function T(t,r){var e=t.readTypedNum[p.UINT8]();if(0===(128&e))return f(t,r,127&e);if(128===(192&e))return s(t,r,63&e);if(192===(224&e))return n(t,(24&e)>>3,7&e);if(224===(240&e)){var i=(15&e)<<16|t.readTypedNum[p.UINT16]();if(i>=t.iref_table.length)throw{name:"IrefError",message:"Invalid IREF #"+i+"!",toString:function(){return this.name+": "+this.message}};return t.iref_table[i]}if(240===(248&e))return t.readTypedNum[7&e]();if(248===(252&e))return b[3&e];if(252===(254&e))return A[2&e];if(254===(255&e)){var a=t.readStringLT();if(void 0===r[a])throw{name:"ImportError",message:"Cannot import undefined external reference "+a+"!",toString:function(){return this.name+": "+this.message}};return r[a]}if(255===(255&e))throw{name:"AssertError",message:"Encountered RESERVED primitive operator!",toString:function(){return this.name+": "+this.message}}}function d(t,r){for(;!t.eof();){var e=t.readTypedNum[p.UINT8]();switch(e){case 248:var i=t.prefix+t.readStringLT();r[i]=T(t,r);break;default:throw{name:"AssertError",message:"Unknown control operator #"+e+" at @"+t.i8+"!",toString:function(){return this.name+": "+this.message}}}}}function c(t,r){var e=t.length,i=Array(e),n=!1;return t.forEach(function(s,a){var u=new XMLHttpRequest;u.open("GET",t[a]),u.responseType="arraybuffer",u.send(),u.addEventListener("readystatechange",function(){if(4===u.readyState)if(200===u.status)i[a]=u.response,0===--e&&r(null);else{if(n)return;r("Error loading "+t[a]+": "+u.statusText),n=!0}})}),i}var l=e(1);const m=0,y=1,p={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7},g={FROM:[p.UINT16,p.INT16,p.UINT32,p.INT32,p.UINT32,p.INT32,p.FLOAT32,p.FLOAT32,p.FLOAT32,p.FLOAT32,p.FLOAT64,p.FLOAT64,p.FLOAT64,p.FLOAT64,p.FLOAT64],TO:[p.UINT8,p.INT8,p.UINT8,p.INT8,p.UINT16,p.INT16,p.UINT8,p.INT8,p.UINT16,p.INT16,p.UINT8,p.INT8,p.UINT16,p.INT16,p.FLOAT32]},N={FROM:[p.UINT16,p.INT16,p.UINT32,p.INT32,p.UINT32,p.INT32],TO:[p.INT8,p.INT8,p.INT8,p.INT8,p.INT16,p.INT16]},I={FROM:[p.FLOAT32,p.FLOAT32,p.FLOAT64,p.FLOAT64],TO:[p.INT8,p.INT16,p.INT8,p.INT16]},v=[Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array],b=([p.UINT16,p.UINT32],[p.UINT8,p.UINT16,p.UINT32,p.FLOAT64],[void 0,null,!1,!0]),A=[NaN];var U=function(t,r,e){"object"==typeof r&&(e=r,r=""),this.database=e||{},this.baseDir=r||"",this.queuedRequests=[],this.objectTable=t,this.__delayGC=[]};U.prototype={constructor:U,add:function(t,r){var e="";this.baseDir&&(e=this.baseDir+"/");var i=t.split("?"),n="",s=[];if(i.length>1&&(n="?"+i[1]),".jbbp"===i[0].substr(i[0].length-5).toLowerCase()){var a=e+i[0].substr(0,i[0].length-5);s=[a+".jbbp",a+"_b16.jbbp",a+"_b32.jbbp",a+"_b64.jbbp"]}else{var t=i[0];".jbb"!=t.substr(t.length-4)&&(t+=".jbb"),s=[e+t+n]}var u={callback:r,status:m,buffer:void 0,url:s};this.queuedRequests.push(u)},addByBuffer:function(t){var r={callback:void 0,status:y,buffer:t,url:void 0};this.queuedRequests.push(r)},load:function(t){this.__process(t)},__process:function(t){var r=this;if(t||(t=function(){}),0===this.queuedRequests.length)return void t(null,this);for(var e=!1,i=0;i<this.queuedRequests.length;i++)if(this.queuedRequests[i].status===m){e=!0;break}if(e)for(var n={counter:0},s=function(){0===--this.counter&&r.__process(t)}.bind(n),a=!1,i=0;i<this.queuedRequests.length;i++){var u=this.queuedRequests[i];u.status===m&&(n.counter++,u.buffer=c(u.url,function(r){return function(e){if(e){if(a)return;var i="Error downloading bundle: "+e;return r.callback&&r.callback(i,null),t&&t(i,null),void(a=!0)}r.status=y,s()}}(u)))}else{for(var i=0;i<this.queuedRequests.length;i++){var u=this.queuedRequests[i];if(u.status===y){var o;o=1===u.buffer.length?new l(u.buffer[0],r.objectTable):new l(u.buffer,r.objectTable),d(o,r.database),u.callback&&u.callback(null,u.bundle)}}this.queuedRequests=[],t(null,this),setTimeout(function(){this.__delayGC=[]}.bind(this),500)}}},t.exports=U},function(t,r){"use strict";var e={UINT8:0,INT8:1,UINT16:2,INT16:3,UINT32:4,INT32:5,FLOAT32:6,FLOAT64:7},i=function(t,r){this.ot=r,this.prefix="",this.sparse=t instanceof Array;var e,i,n,s=32;if(this.sparse?(this.u8=new Uint8Array(t[0]),this.s8=new Int8Array(t[0]),this.u16=new Uint16Array(t[1]),this.s16=new Int16Array(t[1]),this.u32=new Uint32Array(t[2]),this.s32=new Int32Array(t[2]),this.f32=new Float32Array(t[2]),this.f64=new Float64Array(t[3]),e=new Uint16Array(t[0],0,s/2),i=new Uint32Array(t[0],0,s/4),n=t[0].byteLength):(this.u8=new Uint8Array(t),this.s8=new Int8Array(t),this.u16=new Uint16Array(t),this.s16=new Int16Array(t),this.u32=new Uint32Array(t),this.s32=new Int32Array(t),this.f32=new Float32Array(t),this.f64=new Float64Array(t),e=new Uint16Array(t),i=new Uint32Array(t),n=t.byteLength),this.magic=e[0],this.table_id=e[1],this.version=e[2],this.ver_major=255&this.version,this.ver_minor=(65280&this.version)>>8,this.max64=i[2],this.max32=i[3],this.max16=i[4],this.max8=i[5],this.lenST=i[6],this.lenOT=i[7],12610==this.magic)throw{name:"EndianessError",message:"Unfortunately the JBB format is currently only compatible with Little-Endian CPUs",toString:function(){return this.name+": "+this.message}};if(16945!=this.magic)throw{name:"DecodingError",message:"This does not look like a JBB archive! (Magic is 0x"+this.magic.toString(16)+")",toString:function(){return this.name+": "+this.message}};if(258!=this.version)throw{name:"DecodingError",message:"Unsupported bundle version v"+this.ver_minor+"."+this.ver_minor,toString:function(){return this.name+": "+this.message}};if(this.table_id!=this.ot.ID)throw{name:"DecodingError",message:"The object table specified does not match the object table in the binary bundle (0x"+this.table_id.toString(16)+")",toString:function(){return this.name+": "+this.message}};this.sparse?(this.i64=0,this.i32=0,this.i16=0,this.i8=s,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64):(this.i64=s,this.i32=this.i64+this.max64,this.i16=this.i32+this.max32,this.i8=this.i16+this.max16,this.iEnd=this.i8+this.max8-this.lenST,this.ofs8=this.i8,this.ofs16=this.i16,this.ofs32=this.i32,this.ofs64=this.i64,this.i16/=2,this.i32/=4,this.i64/=8),this.iref_table=[];var a="",u=!1;if(this.string_table=[],this.lenST>0){for(var o=this.i8+this.max8,h=o-this.lenST;o>h;h++){var f=this.u8[h];0===f?(this.string_table.push(a),a="",u=!1):(a+=String.fromCharCode(f),u=!0)}u&&this.string_table.push(a)}var T=[],d=0,c=!1;if(this.signature_table=[],this.lenOT>0){for(var o=2*this.i16+this.max16,h=o-this.lenOT;o>h;h+=2){var f=this.u16[h/2];d--?T.push(this.string_table[f]):(c&&this.signature_table.push(T),T=[],d=f,c=!0)}c&&this.signature_table.push(T)}var l=this;this.readTypedNum=[function(){return l.u8[l.i8++]},function(){return l.s8[l.i8++]},function(){return l.u16[l.i16++]},function(){return l.s16[l.i16++]},function(){return l.u32[l.i32++]},function(){return l.s32[l.i32++]},function(){return l.f32[l.i32++]},function(){return l.f64[l.i64++]}],this.sparse?this.readTypedArray=[function(r){var e=l.i8;return l.i8+=r,new Uint8Array(t[0],e,r)},function(r){var e=l.i8;return l.i8+=r,new Int8Array(t[0],e,r)},function(r){var e=2*l.i16;return l.i16+=r,new Uint16Array(t[1],e,r)},function(r){var e=2*l.i16;return l.i16+=r,new Int16Array(t[1],e,r)},function(r){var e=4*l.i32;return l.i32+=r,new Uint32Array(t[2],e,r)},function(r){var e=4*l.i32;return l.i32+=r,new Int32Array(t[2],e,r)},function(r){var e=4*l.i32;return l.i32+=r,new Float32Array(t[2],e,r)},function(r){var e=8*l.i64;return l.i64+=r,new Float64Array(t[3],e,r)}]:this.readTypedArray=[function(r){var e=l.i8;return l.i8+=r,new Uint8Array(t,e,r)},function(r){var e=l.i8;return l.i8+=r,new Int8Array(t,e,r)},function(r){var e=2*l.i16;return l.i16+=r,new Uint16Array(t,e,r)},function(r){var e=2*l.i16;return l.i16+=r,new Int16Array(t,e,r)},function(r){var e=4*l.i32;return l.i32+=r,new Uint32Array(t,e,r)},function(r){var e=4*l.i32;return l.i32+=r,new Int32Array(t,e,r)},function(r){var e=4*l.i32;return l.i32+=r,new Float32Array(t,e,r)},function(r){var e=8*l.i64;return l.i64+=r,new Float64Array(t,e,r)}],this.factory_plain=[],this.factory_plain_bulk=[];for(var h=0;h<this.signature_table.length;h++){for(var m=this.signature_table[h],y=m.length,p="return {",g=p,N=0;y>N;N++)p+="'"+m[N]+"': values["+N+"],",g+="'"+m[N]+"': values["+N+"][i],";p+="}",g+="}",this.factory_plain.push(new Function("values",p)),this.factory_plain_bulk.push(new Function("values","i",g))}};i.prototype.readStringLT=function(){var t=this.readTypedNum[e.UINT16]();if(t>=this.string_table.length)throw{name:"RangeError",message:"String ID is outside than the range of the string lookup table!",toString:function(){return this.name+": "+this.message}};return this.string_table[t]},i.prototype.eof=function(){return this.i8>=this.iEnd},i.prototype.where=function(){console.log("i8=",this.i8-this.ofs8," [U:",this.u8[this.i8],"0x"+this.u8[this.i8].toString(16),"/ S:",this.s8[this.i8],"]"),console.log("i16=",this.i16-this.ofs16/2," [U:",this.u16[this.i16],"/ S:",this.s16[this.i16],"]"),console.log("i32=",this.i32-this.ofs32/4," [U:",this.u32[this.i32],"/ S:",this.s32[this.i32],"/ F:",this.f32[this.i32],"]"),console.log("i64=",this.i64-this.ofs64/8," [F:",this.f64[this.i64],"]")},t.exports=i}]);